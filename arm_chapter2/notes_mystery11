This could be wrong, since I finished it in one shot and didn't recheck. This function is not self-contained, so there isn't much explanation.
